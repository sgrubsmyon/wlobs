<!-- Credit goes to: https://code.tutsplus.com/tutorials/create-a-contact-form-in-php--cms-32314 -->
<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weltladen Bonn Bestellformular</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <!-- <script type="module" src="https://unpkg.com/ionicons@5.0.0/dist/ionicons/ionicons.esm.js"></script> -->
  <!-- <script nomodule="" src="https://unpkg.com/ionicons@5.0.0/dist/ionicons/ionicons.js"></script> -->
  <script nomodule="" src="lib/ionicons.js"></script>
  <script type="module" src="lib/ionicons.esm.js"></script>
</head>

<body>
  <div class="form" id="form">
    <div class="back">
      <a href="https://www.weltladen-bonn.org">‚Üê Zur√ºck zur Webseite</a>
    </div>
    <h1>
      <a href="https://www.weltladen-bonn.org"><img src="logo-weltladen_cmyk.svg" alt="Logo Weltladen Bonn e.V."></a>
      <div>Weltladen Bonn Bestellformular</div>
    </h1>
    <!-- <h2>Wir haben wieder regul√§r ge√∂ffnet, dieses Bestellformular steht Ihnen jedoch weiterhin zur Verf√ºgung.</h2> -->
    <h2>Hier k√∂nnen Sie Produkte bestellen und dann beim Weltladen abholen.</h2>
    <p>
      Liebe Kundinnen und Kunden,
    </p>
    <p>
      Nutzen Sie dieses Formular, um bei uns Produkte zu bestellen und sie am Laden abzuholen.
      Produkte auf Lager k√∂nnen Sie meist schon am n√§chsten Werktag abholen ‚Äì
      wir nennen Ihnen Tag und Uhrzeit, sobald die Bestellung bearbeitet ist.
      Bei Produkten, die wir f√ºr Sie noch bestellen m√ºssen, melden wir uns mit dem
      voraussichtlichen Lieferdatum.
    </p>
    <!-- Collapsible: https://alligator.io/css/collapsible/ -->
    <div class="wrap-collabsible">
      <input id="collapsible" class="toggle" type="checkbox">
      <label for="collapsible" class="lbl-toggle" tabindex="0">So geht's</label>
      <div class="collapsible-content">
        <div class="content-inner">
          <p>
          <ol>
            <li>Geben Sie Ihre Kontaktdaten an, wir ben√∂tigen sie zur Abwicklung der Bestellung (und nur daf√ºr).</li>
            <li>Sie k√∂nnen Lebensmittel (oben) und Handwerksartikel (unten) √ºber zwei Auswahlbereiche hinzuf√ºgen:
              W√§hlen Sie zuerst eine Produktgruppe aus und dann im Feld rechts davon eines der Produkte. Danach k√∂nnen
              Sie daneben die St√ºckzahl eingeben, ganz rechts erscheint der Gesamtpreis f√ºr dieses Produkt.</li>
            <li>√úber den Button (+ Lebensmittel hinzuf√ºgen/Handwerk hinzuf√ºgen) f√ºgen Sie Produkte hinzu, √ºber das
              M√ºlltonnensymbol <span>(<ion-icon name="trash-outline" style="vertical-align: middle;"></ion-icon>)</span>
              k√∂nnen Sie sie l√∂schen. Es gibt keine erforderliche Mindestbestellmenge
              pro Produkt.</li>
            <li>Wenn Sie etwas bestellen m√∂chten, das Sie nicht in der Produktauswahl finden, k√∂nnen Sie es im
              Freitextfeld unter dem Gesamtpreis hinzuf√ºgen.
              Sie k√∂nnen daf√ºr auch auf die Webseiten unserer Lieferanten schauen (s.u.) ‚Äì was dort bestellbar ist,
              k√∂nnen auch wir Ihnen anbieten.
            </li>
            <li>Nach dem Klick auf ‚ÄûAbsenden und Bestellen‚Äú erhalten Sie die √úbersicht Ihrer Bestellung per E-Mail
              zugeschickt.</li>
            <li>Wir melden uns anschlie√üend bei Ihnen, um Ihnen das n√§chste m√∂gliche Abholdatum zu nennen, au√üerdem um
              ggf. offene Fragen zu kl√§ren. Falls der Termin nicht passt, finden wir eine passende Alternative.
              <strong>Wichtig: bitte best√§tigen Sie den Abholtermin, damit die Ware f√ºr Sie gepackt wird.</strong></li>
            <li>Kommen Sie zum vereinbarten Termin zum Laden und holen Sie Ihre Bestellung ab. Bitte halten Sie dabei
              die empfohlenen Hygieneempfehlungen ein, insbesondere den Abstand.</li>
            <li>Freuen Sie sich √ºber leckere Produkte aus Fairem Handel. Sie unterst√ºtzen damit sowohl die lokalen
              Strukturen des Fairen Handels als auch die Fairhandelskooperativen und Kleinproduzent*innen weltweit!</li>
          </ol>
          </p>
          <p>
            Hier kommen Sie zu den Webseiten unserer Lieferanten, wenn Sie nach weiteren Produkten schauen m√∂chten:
          <ul>
            <li>El Puente: <a href="https://shop.el-puente.de/">https://shop.el-puente.de/</a></li>
            <li>Ethiquable: <a href="https://www.ethiquable-shop.de/">https://www.ethiquable-shop.de/</a></li>
            <li>Fairtrade Center Breisgau: <a
                href="https://www.fairtradecenter.info/">https://www.fairtradecenter.info/</a></li>
            <li>Frida Feeling: <a href="https://www.fridafeeling.de/">https://www.fridafeeling.de/</a></li>
            <li>mafiafreie Produkte aus Italien: <a
                href="https://www.legalundlecker.de/">https://www.legalundlecker.de/</a></li>
            <li>GEPA: <a href="https://www.gepa-shop.de/">https://www.gepa-shop.de/</a></li>
            <li>GLOBO: <a href="https://www.globo-fairtrade.com/">https://www.globo-fairtrade.com/</a></li>
            <li>Putumayo: <a href="https://www.putumayo.com/">https://www.putumayo.com/</a></li>
            <li>WeltPartner (ehem. dwp): <a href="https://shop.weltpartner.de/">https://shop.weltpartner.de/</a></li>
          </ul>
          </p>
          <p>
            Bitte beachten Sie: Sollte ein Produkt nur in gr√∂√üeren Mengen (v.a. Lebensmittel) oder zu einem abweichenden
            Preis bestellbar sein, werden wir Sie vor der finalen Bestellung um Best√§tigung bitten.
            Nicht vorr√§tige Ware braucht 1&ndash;2 Wochen, bis sie im Laden ist und abgeholt werden kann.
          </p>
        </div>
      </div>
    </div>
    <h2>Ihre Kontaktdaten:</h2>
    <form action="send-mail.php" method="post">
      <fieldset class="elem-group">
        <label for="name">Vor- und Nachname*</label>
        <input type="text" id="name" name="visitor_name" placeholder="Max Mustermann" pattern="[A-Z\sa-z-]{3,50}"
          required>
      </fieldset>
      <fieldset class="elem-group">
        <label for="email">E-Mail-Adresse*</label>
        <input type="email" id="email" name="visitor_email" placeholder="max.mustermann@beispiel.de" required>
      </fieldset>
      <fieldset class="elem-group">
        <label for="phone">Telefonnummer*</label>
        <input type="text" id="phone" name="visitor_phone" placeholder="0228/12345678" pattern="[+0-9 /\-]{3,30}"
          required>
      </fieldset>
      <!--
        <fieldset class="elem-group">
          <label for="address">Adresse</label>
          <input type="text" id="address" name="visitor_address" placeholder="Max-Mustermann-Stra√üe 12, 53123 Bonn" pattern="[\w\s.,\-\(\)/&+\*]{5,100}" v-bind:required="lieferung_required">
        </fieldset>
      -->

      <h2>Ich m√∂chte folgende Produkte bestellen (vorbehaltlich Lieferbarkeit):</h2>

      <h3>Hinweise:</h3>
      <p class="hint">
      <ul>
        <li>F√ºr mehr Details zum Produkt (soweit verf√ºgbar) auf das Produktbild klicken.</li>
        <li>
          Die gelisteten Produkte sind im Sortiment des Weltladens
          und daher mit einiger Wahrscheinlichkeit vorr√§tig.
          Nicht vorr√§tige Ware kann erst nach 1&ndash;2 Wochen abgeholt werden.
        </li>
        <li>
          Manchmal ist das Bild vom Produkt oder auch die verlinkte Detailseite nicht mehr online.
          Das muss nicht hei√üen, dass Sie den Artikel nicht bestellen k√∂nnen.
          Er kann trotzdem noch im Bonner Weltladen vorr√§tig sein, auch wenn
          er nicht mehr beim Importeur bestellt werden kann.
        </li>
        <li>
          √úber die hier gezeigten Produkte hinaus k√∂nnen viele weitere Produkte
          bestellt werden, wenn sie in den Webshops unserer Importorganisationen
          <a href="https://shop.el-puente.de/">El Puente</a>, <a href="https://www.globo-fairtrade.com/">Globo</a>,
          <a href="https://shop.weltpartner.de/">WeltPartner</a>, <a href="https://www.gepa-shop.de/">GEPA</a>,
          <a href="https://www.fairtradecenter.info/">FairTradeCenter Breisgau</a> und
          <a href="https://www.fridafeeling.de/">Frida Feeling</a> zu finden sind.
          Schreiben Sie die gew√ºnschten Artikelnummern oder -namen in das Textfeld unten.
          Es kann dann aber bis zu zwei Wochen dauern, bis das Produkt im Laden ist.
        </li>
      </ul>
      </p>

      <p>
        <strong>
          Wenn das Formular bei Ihnen nicht funktioniert oder Sie Probleme haben, schicken Sie
          uns bitte Ihre Bestellung per E-Mail: <a href="mailto:info@weltladen-bonn.org">info@weltladen-bonn.org</a>.
          Danke!
        </strong>
      </p>

      <fieldset class="elem-group" id="fieldset-lm">
        <h3>1. Lebensmittel</h3>
        <div v-for="item in items.LM" class="product-selection">
          <produktgruppe typ="LM" v-bind:item="item" v-bind:items="items" v-bind:pgl="productGroupList.LM">
          </produktgruppe>
          <produkt typ="LM" v-bind:item="item" v-bind:curr-formatter="currFormatter"></produkt>
          <stueck typ="LM" v-bind:item="item"></stueck>
          <preis typ="LM" v-bind:item="item" v-bind:curr-formatter="currFormatter"></preis>
          <muelltonne typ="LM" v-bind:item="item" v-bind:items="items"></muelltonne>
        </div>
        <button class="add-prod-button" type="button" v-on:click="addProduct('LM')">+ Lebensmittel hinzuf√ºgen</button>
        <div class="ges-betrag">
          <label for="teil-betrag-lm">Teilbetrag Lebensmittel (evtl. inkl. Pfand):</label>
          <input type="text" id="teil-betrag-lm" v-bind:value="zwischensumme('LM')" disabled>
        </div>
      </fieldset>

      <fieldset class="elem-group" id="fieldset-khw">
        <h3>2. Handwerk</h3>
        <div v-for="item in items.KHW" class="product-selection">
          <produktgruppe typ="KHW" v-bind:item="item" v-bind:items="items" v-bind:pgl="productGroupList.KHW">
          </produktgruppe>
          <produkt typ="KHW" v-bind:item="item" v-bind:curr-formatter="currFormatter"></produkt>
          <stueck typ="KHW" v-bind:item="item"></stueck>
          <preis typ="KHW" v-bind:item="item" v-bind:curr-formatter="currFormatter"></preis>
          <muelltonne typ="KHW" v-bind:item="item" v-bind:items="items"></muelltonne>
        </div>
        <button class="add-prod-button" type="button" v-on:click="addProduct('KHW')">+ Handwerk hinzuf√ºgen</button>
        <div class="ges-betrag">
          <label for="teil-betrag-khw">Teilbetrag Handwerk:</label>
          <input type="text" id="teil-betrag-khw" v-bind:value="zwischensumme('KHW')" disabled>
        </div>
      </fieldset>
      <fieldset class="elem-group">
        <div class="ges-betrag">
          <label for="ges-betrag">Gesamtbetrag (evtl. inkl. Pfand):</label>
          <input type="text" id="ges-betrag" v-bind:value="gesBetrag()" disabled>
        </div>
      </fieldset>
      <fieldset class="elem-group">
        <label for="message">
          Ich habe Interesse an folgenden weiteren Produkten oder folgende Fragen,
          bitte senden Sie mir dazu Informationen zu: (Links zu den Webseiten der Lieferanten:
          siehe ‚ÄûSo geht's‚Äú oben auf der Seite)
        </label>
        <textarea id="message" name="visitor_message"
          placeholder="Hier k√∂nnen Sie z.B. weitere Produkte erw√§hnen, die wir dazu packen sollen."></textarea>
      </fieldset>
      <fieldset class="elem-group checkboxes">
        <input type="checkbox" id="datenschutz" name="datenschutz" value="datenschutz_true" required>
        <label for="datenschutz">
          * Hiermit willige ich ein, dass meine Daten ausschlie√ülich zum Zweck der Abwicklung der hier
          eingegebenen Anfrage und Bestellung verwendet werden. Ist dieser Zweck erf√ºllt, werden meine
          Daten gel√∂scht, sofern keine gesetzlichen Aufbewahrungspflichten dagegen sprechen. Sind alle
          Aufbewahrungspflichten abgelaufen, werden die Daten vollst√§ndig gel√∂scht. Eine Verarbeitung
          zu anderem Zwecke oder Weitergabe an Dritte erfolgt grunds√§tzlich nicht.
          Unsere Datenschutzerkl√§rung
          <a href="https://www.weltladen-bonn.org/index.php/datenschutz" target="_blank"
            rel="noopener noreferrer">finden Sie hier</a>.
        </label>
        <!--
        <input type="checkbox" id="hygiene" name="hygiene" value="hygiene_true" required>
        <label for="hygiene">
          * Hiermit willige ich ein, mich bei der √úbergabe der Bestellung an die derzeitigen Vorgaben
          und Empfehlungen f√ºr den sicheren Kontakt in der √ñffentlichkeit zu halten, beispielsweise
          Vorgaben von Bund, Land und Stadt Bonn sowie Empfehlungen des Robert-Koch-Instituts, um weder
          mich noch die Mitarbeitenden des Weltladens noch andere Kund*innen zu gef√§hrden.
        </label>
        <input type="checkbox" id="lieferung" name="lieferung" value="lieferung_true" v-model="lieferung_required">
        <label for="lieferung">
          Ich geh√∂re zu einer Risikogruppe, habe engen Kontakt mit Personen aus Riskogruppen oder
          befinde mich in Quarant√§ne, weshalb mir der Weg zum Weltladen unm√∂glich oder ein zu hohes
          Risiko ist. Bitte teilen Sie mir mit, ob meine Bestellung an die oben angegebene Anschrift
          geliefert werden kann. F√ºr die Lieferung entstehen keine Kosten.
        </label>
        -->
      </fieldset>
      <label>* = Pflichtfeld</label>
      <fieldset>
        <button type="submit" v-bind:class="{ disabled: buttonIsDisabled() }"
          v-bind:disabled="buttonIsDisabled()">Bestellung abschicken</button>
      </fieldset>
    </form>
  </div>
  <!-- <script src="https://vuejs.org/js/vue.js"></script> (Development version) -->
  <!-- <script src="lib/vue.js"></script> -->
  <!-- <script src="https://vuejs.org/js/vue.min.js"></script> (Production version) -->
  <script src="lib/vue.min.js"></script>
  <!-- <script src="https://unpkg.com/vue-select@latest"></script>
  <link rel="stylesheet" href="https://unpkg.com/vue-select@latest/dist/vue-select.css"> -->
  <!-- <script src="lib/vue-select@latest"></script> -->
  <!-- <link rel="stylesheet" href="lib/vue-select.css"> -->
  <!-- <script src="https://unpkg.com/ionicons@5.0.0/dist/ionicons.js"></script> -->
  <!-- <script src="ionicons.js"></script> -->
  <!-- <script src="https://unpkg.com/axios/dist/axios.min.js"></script> -->
  <script src="lib/axios.min.js"></script>
  <script>
    function easter(year) {
      // https://www.irt.org/articles/js052/index.htm
      var century = Math.floor(year / 100);
      var N = year - 19 * Math.floor(year / 19);
      var K = Math.floor((century - 17) / 25);
      var I = century - Math.floor(century / 4) - Math.floor((century - K) / 3) + 19 * N + 15;
      I = I - 30 * Math.floor((I / 30));
      I = I - Math.floor(I / 28) * (1 - Math.floor(I / 28) * Math.floor(29 / (I + 1)) * Math.floor((21 - N) / 11));
      var J = year + Math.floor(year / 4) + I + 2 - century + Math.floor(century / 4);
      J = J - 7 * Math.floor(J / 7);
      var L = I - J;
      var month = 3 + Math.floor((L + 40) / 44);
      var day = L + 28 - 31 * Math.floor(month / 4);

      return new Date(`${year}-${month}-${day}`);
    }

    window.onload = function () {
      // Collapsible: https://alligator.io/css/collapsible/
      let myLabels = document.querySelectorAll('.lbl-toggle');
      Array.from(myLabels).forEach(label => {
        label.addEventListener('keydown', e => {
          // 32 === spacebar
          // 13 === enter
          if (e.which === 32 || e.which === 13) {
            e.preventDefault();
            label.click();
          };
        });
      });
    }

    // Vue.component('v-select', VueSelect.VueSelect);

    Vue.config.ignoredElements = [/^ion-/];

    function imgStyle(url) {
      return "background-image: url('" + url + "');";
    };

    function loadProdImageFromElPuente(prod, art_nr, fallback_url, loading_url) {
      let url = loading_url;
      prod.imgStyle = imgStyle(url);
      // get the image path via a web API call
      axios.post("query-ep-image.php", {
        art_nr: art_nr
      })
        .then(response => {
          if (response.data && response.data.length > 0) {
            url = response.data[0].image; // this image is really small (thumbnail)
            prod.imgStyle = imgStyle(url); // use this thumbnail image first as it's better than nothing
            // Try to load larger image now:
            let img_filename = url.split('/').pop(); // get everything after the last occurrence of a slash
            img_filename = img_filename.substring(0, img_filename.lastIndexOf('.')); // remove the extension
            url = `https://www.el-puente.de/media/webp_image/catalog/product/cache/a7c6ae90704e4fffb85e1e61c39fd445/3/6/${img_filename}.webp`;
            prod.imgStyle = imgStyle(url); // load the larger image
          }
        })
        .catch(error => {
          url = fallback_url;
          prod.imgStyle = imgStyle(url);
        });
      return url;
    }

    function loadProdImageFromGEPA(prod, art_nr, fallback_url, loading_url) {
      let url = loading_url;
      prod.imgStyle = imgStyle(url);
      axios.get(`https://www.gepa-shop.de/searchautocomplete/ajax/suggest/?q=${art_nr}`)
        .then(response => {
          if (response.data && response.data.totalItems === 1) {
            const gepa_prod_data = response.data.indexes[0].items[0];
            url = gepa_prod_data.imageUrl;
            prod.imgStyle = imgStyle(url); // use this thumbnail image first as it's better than nothing
            
            // set the product's detail website URL
            const prodUrl = gepa_prod_data.url;
            if (prodUrl) {
              console.log("GEPA prodUrl: " + prodUrl, "for prod", prod);
              prod.prodUrl = prodUrl;
            }
            
            // Try to load larger image now:
            const base_url = url.split("?")[0];
            const url_params = new URLSearchParams(url.split("?")[1]);
            url_params.set("width", "700");
            url_params.set("height", "700");
            url_params.set("canvas", "700,700");
            url = base_url + "?" + url_params.toString();
            prod.imgStyle = imgStyle(url); // load the larger image
          }
        })
        .catch(error => {
          url = fallback_url;
          prod.imgStyle = imgStyle(url);
        });
      return url;
    }

    function loadProdImageFromGlobo(prod, art_nr, fallback_url, loading_url) {
      let url = loading_url;
      prod.imgStyle = imgStyle(url);
      axios.post("query-globo-image.php", {
        art_nr: art_nr
      })
        .then(response => {
          if (response.data) {
            if (response.data.message) {
              // there is an error message, it has not worked
              url = fallback_url;
              prod.imgStyle = imgStyle(url);    
            } else {
              const dom = document.createElement("template");
              dom.innerHTML = response.data;
              const img = dom.content.querySelector(".product--image-container .image--media > img"); // larger image
              // const img = dom.content.querySelector("img"); // smaller image, then use "srcset" attribute
              if (img) {
                url = img.src;
                prod.imgStyle = imgStyle(url);
              } else {
                url = fallback_url;
                prod.imgStyle = imgStyle(url);
              }
            }
          }
        })
        .catch(error => {
          url = fallback_url;
          prod.imgStyle = imgStyle(url);
        });
      return url;
    }

    // Define a new component
    Vue.component('produktgruppe', {
      props: ['typ', 'item', 'items', 'pgl'],
      methods: {
        productsInGroupPromise: function (productgroup, typ) {
          /* https://www.thetechieshouse.com/vue-js-rest-api-example-with-axios-ajax-alternative/ */
          /* https://stackoverflow.com/questions/49661209/get-response-from-axios-with-await-async */
          return axios.get('api/artikel/read_group.php', {
            params: {
              name: productgroup,
              typ: typ
            }
          })
            .then(response => response.data.records)
            .catch(error => console.log(error));
        },
        updateItemProducts: function (typ, position) {
          let item = this.items[typ][position - 1];
          this.productsInGroupPromise(item.productgroup, typ)
            .then(prods => {
              prods.forEach(prod => {
                this.setProdURL(typ, prod);
                this.setImageStyle(typ, prod);
              });
              item.products = prods;
              item.id = "";
              item.lieferant_name = "";
              item.artikel_nr = "";
              item.artikel_name = "";
              item.vk_preis = 0;
              item.pfand = 0;
              item.stueck = 1;
              item.showProdDropdown = false;
            });
        },
        setImageStyle: function (typ, prod) {
          let art_nr = prod.artikel_nr.trim().toLowerCase();
          let fallback_url = 'KeinBild.png';
          let loading_url = 'BildLaden.png';
          let url = '';
          switch (prod.lieferant_name) {
            case 'El Puente':
              url = loadProdImageFromElPuente(prod, art_nr, fallback_url, loading_url);
              break;
            case 'WeltPartner':
              // url = 'https://shop.weltpartner.de/images/stories/virtuemart/product/resized/' + art_nr + '_380x380.jpg';
              url = 'https://shop.weltpartner.de/images/stories/virtuemart/product/' + art_nr + '.jpg'; // for full-sized image
              prod.imgStyle = imgStyle(url);
              break;
            case 'GEPA':
              url = loadProdImageFromGEPA(prod, art_nr, fallback_url, loading_url);
              break;
            case 'Globo':
              url = loadProdImageFromGlobo(prod, art_nr.toUpperCase(), fallback_url, loading_url);
              break;
            default:
              url = fallback_url;
              prod.imgStyle = imgStyle(url);
          }
          console.log("url: " + url);
          // Check if image is available and if not: replace with fallback image
          let img = new Image();
          img.onerror = function () {
            console.log('Image ' + this.src + ' not there.');
            url = fallback_url;
            prod.imgStyle = imgStyle(url);
          };
          img.src = url;
        },
        prodURL: function (typ, prod) {
          let url = '';
          let art_nr = prod.artikel_nr.trim().toLowerCase();
          switch (prod.lieferant_name) {
            case 'El Puente':
              art_nr = art_nr.replace(/ /g, '-');
              url = 'https://shop.el-puente.de/' + art_nr;
              break;
            case 'WeltPartner':
              art_nr = art_nr.replace(/ /g, '-');
              art_nr = art_nr.substring(0, 10).toUpperCase();
              // url = 'https://shop.weltpartner.de/suche?keyword=' + art_nr; // old
              url = 'https://shop.weltpartner.de/filter?q=' + art_nr;
              break;
            case 'GEPA':
              let art_nr_alphanum = art_nr.replace(/[^\w]/g, ''); // only keep a-z and 0-9
              if (typ == 'LM') {
                url = `https://www.gepa-shop.de/media/downloadable/produktpaesse/${art_nr_alphanum}.pdf`
                break;
              } else if (typ == 'KHW') {
                url = `https://www.gepa-shop.de/catalogsearch/result/?q=${art_nr_alphanum}`;
                break;
              }
            case 'Globo':
              // url = 'https://www.globo-fairtrade.com/search?sSearch=' + art_nr.toUpperCase(); // old, still working
              url = "https://www.globo-fairtrade.com/search/index/sSearch/" + art_nr.toUpperCase(); // this seems to be normal now
              break;
            default:
              url = '';
          }
          return url;
        },
        setProdURL: function (typ, prod) {
          prod.prodURL = this.prodURL(typ, prod);
        },
        emojiPG: function (pg, typ) {
          switch (pg) {
            case 'Weihnachten':
              if (typ == 'LM') pg = pg + ' üç™üç´';
              else if (typ == 'KHW') pg = pg + ' üéÑüéÅ';
              break;
            case 'Ostern':
              pg = pg + ' ü•öüêá';
              break;
            case 'Saatgut':
              pg = pg + ' üå±üçÜ';
          }
          return pg;
        }
      },
      template: `
        <div class="produktgruppe">
          <label v-bind:for="'productgroup'+item.position">Produktgruppe</label>
          <select v-bind:id="'productgroup-'+typ.toLowerCase()+'-'+item.position" v-bind:name="'productgroup-'+typ.toLowerCase()+'-'+item.position" v-model="item.productgroup" v-on:change="updateItemProducts(typ, item.position)" required>
            <option value="" disabled selected>Bitte ausw√§hlen...</option>
            <option v-for="pg in pgl" v-bind:value="pg">{{ emojiPG(pg, typ) }}</option>
          </select>
        </div>
      `
    });

    Vue.component('produkt', {
      props: ['typ', 'item', 'curr-formatter'],
      methods: {
        updateItem: function (item) {
          const prod = item.products.filter(p => {
            let id = item.id.split("______");
            return p.lieferant_name === id[0] && p.artikel_nr === id[1]
          })[0];
          item.lieferant_name = prod.lieferant_name;
          item.artikel_nr = prod.artikel_nr;
          item.artikel_name = prod.artikel_name;
          item.vk_preis = prod.vk_preis;
          item.pfand = prod.pfand;
          item.imgStyle = prod.imgStyle;
          item.prodURL = prod.prodURL;
        }
      },
      template: `
        <div class="produkt">
          <label v-bind:for="'product'+item.position">Produkt</label>
          <div class="custom-select">
            <select v-bind:id="'product-'+typ.toLowerCase()+'-'+item.position" v-bind:name="'product-'+typ.toLowerCase()+'-'+item.position" v-model="item.id" v-on:change="updateItem(item)" required>
              <option value="" disabled selected>Bitte ausw√§hlen...</option>
              <option v-for="p in item.products" v-bind:value="p.lieferant_name+'______'+p.artikel_nr">{{ p.artikel_name + ' (' + p.lieferant_name + ')' }}</option>
            </select>
            <div class="select-selected" @click="item.showProdDropdown = !item.showProdDropdown" :class="{ 'select-arrow-active': item.showProdDropdown, 'nothing-selected': item.id == '' }">
              <div v-if="item.prodURL != ''" class="produktimg" title="Klicken f√ºr mehr Infos">
                <a target="_blank" rel="noopener noreferrer" :href="item.prodURL">
                  <div :style="item.imgStyle"></div>
                </a>
              </div>
              <div v-else class="produktimg">
                <div :style="item.imgStyle"></div>
              </div>
              <div class="produktname">
                <div :title="item.artikel_name">{{ item.artikel_name }}</div>
              </div>
              <div class="lieferant">{{ item.lieferant_name }}</div>
              <div class="preis">{{ currFormatter.format(item.vk_preis) }}</div>
              <div class="produktpfeil">
                <div></div>
              </div>
            </div>
            <div class="select-items" v-show="item.showProdDropdown">
              <div v-for="p in item.products" v-on:click="item.id = p.lieferant_name+'______'+p.artikel_nr; updateItem(item)">
                <div v-if="p.prodURL != ''" class="produktimg" title="Klicken f√ºr mehr Infos">
                  <a target="_blank" rel="noopener noreferrer" :href="p.prodURL">
                    <div :style="p.imgStyle"></div>
                  </a>
                </div>
                <div v-else class="produktimg">
                  <div :style="p.imgStyle"></div>
                </div>
                <div class="produktname">
                  <div :title="p.artikel_name">{{ p.artikel_name }}</div>
                </div>
                <div class="lieferant">{{ p.lieferant_name }}</div>
                <div class="preis">{{ currFormatter.format(p.vk_preis) }}</div>
              </div>
            </div>
          </div>
        </div>
      `
    });

    Vue.component('stueck', {
      props: ['typ', 'item'],
      template: `
        <div class="stueck">
          <label v-bind:for="'stueck'+item.position">St√ºck</label>
          <input type="number" v-bind:id="'stueck-'+typ.toLowerCase()+'-'+item.position" v-bind:name="'stueck-'+typ.toLowerCase()+'-'+item.position" min="1" max="1000" v-model="item.stueck">
        </div>
      `
    });

    Vue.component('preis', {
      props: ['typ', 'item', 'curr-formatter'],
      methods: {
        preis: function (item) {
          return this.currFormatter.format(item.vk_preis * item.stueck);
        }
      },
      template: `
        <div class="preis">
          <label v-bind:for="'preis'+item.position">Preis</label>
          <input type="text" v-bind:id="'preis-'+typ.toLowerCase()+'-'+item.position" v-bind:name="'preis-'+typ.toLowerCase()+'-'+item.position" v-bind:value="preis(item)" disabled>
        </div>
      `
    });

    Vue.component('muelltonne', {
      props: ['typ', 'item', 'items'],
      methods: {
        removeProduct: function (typ, position) {
          this.items[typ].splice(position - 1, 1);
          // same behavior as:
          // Vue.delete(this.items[typ], position - 1);
          /* reassign positions as it is necessary when product was not removed from end */
          let i = 1;
          for (let item of this.items[typ]) {
            item.position = i;
            i += 1;
          }
        }
      },
      template: `
        <button type="button" class="muelltonne square" v-on:click="removeProduct(typ, item.position)"><ion-icon name="trash-outline"></ion-icon></button>
      `
    });

    let itemPrototype = {
      position: 1,
      productgroup: "",
      products: [],
      id: "",
      lieferant_name: "",
      artikel_nr: "",
      artikel_name: "",
      vk_preis: 0,
      pfand: 0,
      imgStyle: "",
      prodURL: "",
      stueck: 1,
      showProdDropdown: false
    };

    var app = new Vue({
      el: '#form',
      data: {
        productGroupList: {
          LM: [],
          KHW: []
        },
        items: {
          LM: [], // start with empty list, in order to not enforce that a product of each type must be chosen
          KHW: [] // start with empty list, in order to not enforce that a product of each type must be chosen
        },
        lieferung_required: false,
        currFormatter: Intl.NumberFormat('de-DE', {
          style: 'currency',
          currency: 'EUR'
        })
      },
      methods: {
        addProduct: function (typ) {
          let currPosition = 0;
          if (this.items[typ].length > 0) {
            currPosition = this.items[typ][this.items[typ].length - 1].position;
          }
          let anotherPrototype = Object.assign({}, itemPrototype); // create a new copy, no reference
          anotherPrototype.position = currPosition + 1;
          this.items[typ].push(anotherPrototype);
        },
        zwischensummen: function (typ) {
          let zs = { preis: 0, pfand: 0 };
          for (let i of this.items[typ]) {
            zs.preis = zs.preis + i.vk_preis * i.stueck;
            if (i.pfand) {
              zs.pfand = zs.pfand + i.pfand * i.stueck;
            }
          }
          return zs;
        },
        zwischensumme: function (typ) {
          let values = Object.values(this.zwischensummen(typ));
          let sum = values.reduce((a, b) => a + b);
          return this.currFormatter.format(sum);
        },
        gesBetrag: function () {
          let gesPreis = 0;
          let gesPfand = 0;
          for (let typ of Object.keys(this.items)) {
            let zs = this.zwischensummen(typ);
            gesPreis += zs.preis;
            gesPfand += zs.pfand;
          }
          return this.currFormatter.format(gesPreis + gesPfand);
        },
        buttonIsDisabled: function () {
          let l = 0;
          for (let typ of Object.keys(this.items)) {
            l += this.items[typ].length;
          }
          return (l < 1);
        }
      },
      mounted: function () {
        // Get current date in order to determine whether seasonal products should be displayed
        const date = new Date();

        // Define time when Christmas products should be displayed:
        const christmas_start = new Date(`${date.getFullYear()}-11-12`); // start one day after St. Martin (November 12th)
        const christmas_end = new Date(`${date.getFullYear()}-01-07`); // end one day after Epiphany (January 7th)

        // Define time when Easter products should be displayed:
        const easter_date = easter(date.getFullYear());
        const easter_start = new Date(easter_date);
        easter_start.setDate(easter_start.getDate() - 46); // start 46 days before Easter Sunday (on Ash Wednesday)
        const easter_end = new Date(easter_date); // end two days after Easter Sunday (Tuesday after Easter)
        easter_end.setDate(easter_end.getDate() + 2); // start 45 days before Easter Sunday (one day after Ash Wednesday)

        // Define time when seed products should be displayed:
        const seed_start = new Date(`${date.getFullYear()}-02-01`); // start of the gardener's year (February 1st)
        const seed_end = new Date(`${date.getFullYear()}-05-01`); // end of the seeding season (May 1st)

        axios.get('api/produktgruppe/read_all.php', {
          params: {
            typ: "LM"
          }
        })
          .then(response => {
            let pgl = response.data.records;
            pgl = pgl.filter(pg => pg !== "Bananen");

            if (date < christmas_end || date > christmas_start) {
              // Put 'Weihnachten' at the top:
              pgl = ['Weihnachten'].concat(pgl.filter(pg => pg !== "Weihnachten"));
            } else {
              // Remove 'Weihnachten':
              pgl = pgl.filter(pg => pg !== "Weihnachten");
            }

            // --------------------------------------------------

            if (date > easter_start && date < easter_end) {
              // Put 'Ostern' at the top:
              pgl = ['Ostern'].concat(pgl.filter(pg => pg !== "Ostern"));
            } else {
              // Remove 'Ostern':
              pgl = pgl.filter(pg => pg !== "Ostern");
            }

            // --------------------------------------------------

            if (date > seed_start && date < seed_end) {
              // Put 'Saatgut' at the very top:
              pgl = ['Saatgut'].concat(pgl.filter(pg => pg !== "Saatgut"))
            } else {
              // Remove 'Saatgut':
              pgl = pgl.filter(pg => pg !== "Saatgut");
            }

            app.productGroupList.LM = pgl;
          })
          .catch(error => console.log(error));
        axios.get('api/produktgruppe/read_all.php', {
          params: {
            typ: "KHW"
          }
        })
          .then(response => {
            let pgl = response.data.records;

            if (date < christmas_end || date > christmas_start) {
              // Put 'Weihnachten' at the top:
              pgl = ['Weihnachten'].concat(pgl.filter(pg => pg !== "Weihnachten"));
            } else {
              // Remove 'Weihnachten':
              pgl = pgl.filter(pg => pg !== "Weihnachten");
            }

            // --------------------------------------------------

            if (date > easter_start && date < easter_end) {
              // Put 'Ostern' at the top:
              pgl = ['Ostern'].concat(pgl.filter(pg => pg !== "Ostern"));
            } else {
              // Remove 'Ostern':
              pgl = pgl.filter(pg => pg !== "Ostern");
            }

            app.productGroupList.KHW = pgl;
          })
          .catch(error => console.log(error));
      }
    });

    /* If the user clicks anywhere outside the select box: close select box(es): */
    document.addEventListener("click", function (e) {
      let cls = "select-selected";
      if (!e.target.classList.contains(cls) &&
        (!e.target.parentNode.classList || !e.target.parentNode.classList.contains(cls)) && // either parent node does not exist (<html>) or it does not have the class
        (!e.target.parentNode.parentNode || !e.target.parentNode.parentNode.classList || !e.target.parentNode.parentNode.classList.contains(cls))) { // either parent node's parent node does not exist (<body>) or it does not have the class
        // close all dropdowns:
        for (let typ of Object.keys(app.items)) {
          for (let item of app.items[typ]) {
            item.showProdDropdown = false;
          }
        }
      }
    });
  </script>
</body>

</html>