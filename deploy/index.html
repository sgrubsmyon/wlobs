<!-- Credit goes to: https://code.tutsplus.com/tutorials/create-a-contact-form-in-php--cms-32314 -->
<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weltladen Bonn Bestellformular</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <!-- <script type="module" src="https://unpkg.com/ionicons@5.0.0/dist/ionicons/ionicons.esm.js"></script> -->
  <!-- <script nomodule="" src="https://unpkg.com/ionicons@5.0.0/dist/ionicons/ionicons.js"></script> -->
  <script nomodule="" src="lib/ionicons.js"></script>
  <script type="module" src="lib/ionicons.esm.js"></script>
</head>

<body>
  <div class="form" id="form">
    <div class="back">
      <a href="https://www.weltladen-bonn.org">‚Üê Zur√ºck zur Webseite</a>
    </div>
    <h1>
      <a href="https://www.weltladen-bonn.org"><img src="logo-weltladen_cmyk.svg" alt="Logo Weltladen Bonn e.V."></a>
      <div>Weltladen Bonn Bestellformular</div>
    </h1>
    <!-- <h2>Wir haben wieder regul√§r ge√∂ffnet, dieses Bestellformular steht Ihnen jedoch weiterhin zur Verf√ºgung.</h2> -->
    <h2>Hier k√∂nnen Sie Produkte bestellen und dann beim Weltladen abholen.</h2>
    <p>
      Liebe Kundinnen und Kunden,
    </p>
    <p>
      <!-- XXX Ggf. √§ndern: -->
      ab dem 4.1.2021 sind wir gerne im Rahmen des M√∂glichen wieder f√ºr Sie da!
      Nutzen Sie dieses Formular, um uns Ihre W√ºnsche mitzuteilen.
      Produkte auf Lager k√∂nnen Sie meist schon am n√§chsten Werktag abholen ‚Äì
      wir nennen Ihnen Tag und Uhrzeit, sobald die Bestellung bearbeitet ist.
      Bei Produkten, die wir f√ºr Sie noch bestellen m√ºssen, melden wir uns mit dem
      voraussichtlichen Lieferdatum.
      Sobald der Lockdown vorbei ist (11.1. oder sp√§ter), werden wir zu den gewohnten
      √ñffnungszeiten wieder f√ºr Sie da sein.
    </p>
    <!-- Collapsible: https://alligator.io/css/collapsible/ -->
    <div class="wrap-collabsible">
      <input id="collapsible" class="toggle" type="checkbox">
      <label for="collapsible" class="lbl-toggle" tabindex="0">So geht's</label>
      <div class="collapsible-content">
        <div class="content-inner">
          <p>
            <ol>
              <li>Geben Sie Ihre Kontaktdaten an, wir ben√∂tigen sie zur Abwicklung der Bestellung (und nur daf√ºr).</li>
              <li>Sie k√∂nnen Lebensmittel (oben) und Handwerksartikel (unten) √ºber zwei Auswahlbereiche hinzuf√ºgen:
                W√§hlen Sie zuerst eine Produktgruppe aus und dann im Feld rechts davon eines der Produkte. Danach k√∂nnen Sie daneben die St√ºckzahl eingeben, ganz rechts erscheint der Gesamtpreis f√ºr dieses Produkt.</li>
              <li>√úber den Button (+ Lebensmittel hinzuf√ºgen/Handwerk hinzuf√ºgen) f√ºgen Sie Produkte hinzu, √ºber das M√ºlltonnensymbol <span>(<ion-icon name="trash-outline" style="vertical-align: middle;"></ion-icon>)</span> k√∂nnen Sie sie l√∂schen. Es gibt keine erforderliche Mindestbestellmenge
                pro Produkt.</li>
              <li>Wenn Sie etwas bestellen m√∂chten, das Sie nicht in der Produktauswahl finden, k√∂nnen Sie es im Freitextfeld unter dem Gesamtpreis hinzuf√ºgen.
                Sie k√∂nnen daf√ºr auch auf die Webseiten unserer Lieferanten schauen (s.u.) ‚Äì was dort bestellbar ist, k√∂nnen auch wir Ihnen anbieten.
              </li>
              <li>Nach dem Klick auf ‚ÄûAbsenden und Bestellen‚Äú erhalten Sie die √úbersicht Ihrer Bestellung per E-Mail zugeschickt.</li>
              <li>Wir melden uns anschlie√üend bei Ihnen, um Ihnen das n√§chste m√∂gliche Abholdatum zu nennen, au√üerdem um ggf. offene Fragen zu kl√§ren. Falls der Termin nicht passt, finden wir eine passende Alternative. <strong>Wichtig: bitte best√§tigen Sie den Abholtermin, damit die Ware f√ºr Sie gepackt wird.</strong></li>
              <li>Kommen Sie zum vereinbarten Termin zum Laden und holen Sie Ihre Bestellung ab. Bitte halten Sie dabei die empfohlenen Hygieneempfehlungen ein, insbesondere den Abstand.</li>
              <li>Freuen Sie sich √ºber leckere Produkte aus Fairem Handel. Sie unterst√ºtzen damit sowohl die lokalen Strukturen des Fairen Handels als auch die Fairhandelskooperativen und Kleinproduzent*innen weltweit!</li>
            </ol>
          </p>
          <p>
            Hier kommen Sie zu den Webseiten unserer Lieferanten, wenn Sie nach weiteren Produkten schauen m√∂chten:
            <ul>
              <li>El Puente: <a href="https://shop.el-puente.de/">https://shop.el-puente.de/</a></li>
              <li>Ethiquable: <a href="https://www.ethiquable-shop.de/">https://www.ethiquable-shop.de/</a></li>
              <li>Fairtrade Center Breisgau: <a href="https://www.fairtradecenter.info/">https://www.fairtradecenter.info/</a></li>
              <li>Frida Feeling: <a href="https://www.fridafeeling.de/">https://www.fridafeeling.de/</a></li>
              <li>mafiafreie Produkte aus Italien: <a href="https://www.legalundlecker.de/">https://www.legalundlecker.de/</a></li>
              <li>GEPA: <a href="https://www.gepa-shop.de/">https://www.gepa-shop.de/</a></li>
              <li>GLOBO: <a href="https://www.globo-fairtrade.com/">https://www.globo-fairtrade.com/</a></li>
              <li>Putumayo: <a href="https://www.putumayo.com/">https://www.putumayo.com/</a></li>
              <li>WeltPartner (ehem. dwp): <a href="https://shop.weltpartner.de/">https://shop.weltpartner.de/</a></li>
            </ul>
          </p>
          <p>
            Bitte beachten Sie: Sollte ein Produkt nur in gr√∂√üeren Mengen (v.a. Lebensmittel) oder zu einem abweichenden Preis bestellbar sein, werden wir Sie vor der finalen Bestellung um Best√§tigung bitten.
            Nicht vorr√§tige Ware braucht 1-2 Wochen, bis sie im Laden ist und abgeholt werden kann.
          </p>
        </div>
      </div>
    </div>
    <h2>Ihre Kontaktdaten:</h2>
    <form action="send-mail.php" method="post">
      <fieldset class="elem-group">
        <label for="name">Vor- und Nachname*</label>
        <input type="text" id="name" name="visitor_name" placeholder="Max Mustermann" pattern="[A-Z\sa-z-]{3,50}" required>
      </fieldset>
      <fieldset class="elem-group">
        <label for="email">E-Mail-Adresse*</label>
        <input type="email" id="email" name="visitor_email" placeholder="max.mustermann@beispiel.de" required>
      </fieldset>
      <fieldset class="elem-group">
        <label for="phone">Telefonnummer*</label>
        <input type="text" id="phone" name="visitor_phone" placeholder="0228/12345678" pattern="[+0-9 /\-]{3,30}" required>
      </fieldset>
      <!--
        <fieldset class="elem-group">
          <label for="address">Adresse</label>
          <input type="text" id="address" name="visitor_address" placeholder="Max-Mustermann-Stra√üe 12, 53123 Bonn" pattern="[\w\s.,\-\(\)/&+\*]{5,100}" v-bind:required="lieferung_required">
        </fieldset>
      -->
      
      <h2>Ich m√∂chte folgende Produkte bestellen (vorbehaltlich Lieferbarkeit):</h2>

      <h3>Hinweise:</h3>
      <p class="hint">
        <ul>
          <li>F√ºr mehr Details zum Produkt (soweit verf√ºgbar) auf das Produktbild klicken.</li>
          <li>
            Die gelisteten Produkte sind im Sortiment des Weltladens
            und daher mit einiger Wahrscheinlichkeit vorr√§tig.
            Nicht vorr√§tige Ware kann erst nach 1&ndash;2 Wochen abgeholt werden.
          </li>
          <li>
            Manchmal ist das Bild vom Produkt oder auch die verlinkte Detailseite nicht mehr online.
            Das muss nicht hei√üen, dass Sie den Artikel nicht bestellen k√∂nnen.
            Er kann trotzdem noch im Bonner Weltladen vorr√§tig sein, auch wenn
            er nicht mehr beim Importeur bestellt werden kann.
          </li>
          <li>
            √úber die hier gezeigten Produkte hinaus k√∂nnen viele weitere Produkte
            bestellt werden, wenn sie in den Webshops unserer Importorganisationen
            <a href="https://shop.el-puente.de/">El Puente</a>, <a href="https://www.globo-fairtrade.com/">Globo</a>,
            <a href="https://shop.weltpartner.de/">WeltPartner</a>, <a href="https://www.gepa-shop.de/">GEPA</a>,
            <a href="https://www.fairtradecenter.info/">FairTradeCenter Breisgau</a> und
            <a href="https://www.fridafeeling.de/">Frida Feeling</a> zu finden sind.
            Schreiben Sie die gew√ºnschten Artikelnummern oder -namen in das Textfeld unten.
            Es kann dann aber bis zu zwei Wochen dauern, bis das Produkt im Laden ist.
          </li>
        </ul>
      </p>
      
      <fieldset class="elem-group" id="fieldset-lm">
        <h3>1. Lebensmittel</h3>
        <div v-for="item in items.LM" class="product-selection">
          <produktgruppe typ="LM" v-bind:item="item" v-bind:items="items" v-bind:pgl="productGroupList.LM"></produktgruppe>
          <produkt typ="LM" v-bind:item="item" v-bind:curr-formatter="currFormatter"></produkt>
          <stueck typ="LM" v-bind:item="item"></stueck>
          <preis typ="LM" v-bind:item="item" v-bind:curr-formatter="currFormatter"></preis>
          <muelltonne typ="LM" v-bind:item="item" v-bind:items="items"></muelltonne>
        </div>
        <button class="add-prod-button" type="button" v-on:click="addProduct('LM')">+ Lebensmittel hinzuf√ºgen</button>
        <div class="ges-betrag">
          <label for="teil-betrag-lm">Teilbetrag Lebensmittel (evtl. inkl. Pfand):</label>
          <input type="text" id="teil-betrag-lm" v-bind:value="zwischensumme('LM')" disabled>
        </div>
      </fieldset>

      <fieldset class="elem-group" id="fieldset-khw">
        <h3>2. Handwerk</h3>
        <div v-for="item in items.KHW" class="product-selection">
          <produktgruppe typ="KHW" v-bind:item="item" v-bind:items="items" v-bind:pgl="productGroupList.KHW"></produktgruppe>
          <produkt typ="KHW" v-bind:item="item" v-bind:curr-formatter="currFormatter"></produkt>
          <stueck typ="KHW" v-bind:item="item"></stueck>
          <preis typ="KHW" v-bind:item="item" v-bind:curr-formatter="currFormatter"></preis>
          <muelltonne typ="KHW" v-bind:item="item" v-bind:items="items"></muelltonne>
        </div>
        <button class="add-prod-button" type="button" v-on:click="addProduct('KHW')">+ Handwerk hinzuf√ºgen</button>
        <div class="ges-betrag">
          <label for="teil-betrag-khw">Teilbetrag Handwerk:</label>
          <input type="text" id="teil-betrag-khw" v-bind:value="zwischensumme('KHW')" disabled>
        </div>
      </fieldset>
      <fieldset class="elem-group">
        <div class="ges-betrag">
          <label for="ges-betrag">Gesamtbetrag (evtl. inkl. Pfand):</label>
          <input type="text" id="ges-betrag" v-bind:value="gesBetrag()" disabled>
        </div>
      </fieldset>
      <fieldset class="elem-group">
        <label for="message">
          Ich habe Interesse an folgenden weiteren Produkten oder folgende Fragen,
          bitte senden Sie mir dazu Informationen zu: (Links zu den Webseiten der Lieferanten:
          siehe ‚ÄûSo geht's‚Äú oben auf der Seite)
        </label>
        <textarea id="message" name="visitor_message" placeholder="Hier k√∂nnen Sie z.B. weitere Produkte erw√§hnen, die wir dazu packen sollen."></textarea>
      </fieldset>
      <fieldset class="elem-group checkboxes">
        <input type="checkbox" id="datenschutz" name="datenschutz" value="datenschutz_true" required>
        <label for="datenschutz">
          * Hiermit willige ich ein, dass meine Daten ausschlie√ülich zum Zweck der Abwicklung der hier
          eingegebenen Anfrage und Bestellung verwendet werden. Ist dieser Zweck erf√ºllt, werden meine
          Daten gel√∂scht, sofern keine gesetzlichen Aufbewahrungspflichten dagegen sprechen. Sind alle
          Aufbewahrungspflichten abgelaufen, werden die Daten vollst√§ndig gel√∂scht. Eine Verarbeitung
          zu anderem Zwecke oder Weitergabe an Dritte erfolgt grunds√§tzlich nicht.
          Unsere Datenschutzerkl√§rung
          <a href="https://www.weltladen-bonn.org/index.php/datenschutz" target="_blank" rel="noopener noreferrer">finden Sie hier</a>.
        </label>
        <!--
        <input type="checkbox" id="hygiene" name="hygiene" value="hygiene_true" required>
        <label for="hygiene">
          * Hiermit willige ich ein, mich bei der √úbergabe der Bestellung an die derzeitigen Vorgaben
          und Empfehlungen f√ºr den sicheren Kontakt in der √ñffentlichkeit zu halten, beispielsweise
          Vorgaben von Bund, Land und Stadt Bonn sowie Empfehlungen des Robert-Koch-Instituts, um weder
          mich noch die Mitarbeitenden des Weltladens noch andere Kund*innen zu gef√§hrden.
        </label>
        <input type="checkbox" id="lieferung" name="lieferung" value="lieferung_true" v-model="lieferung_required">
        <label for="lieferung">
          Ich geh√∂re zu einer Risikogruppe, habe engen Kontakt mit Personen aus Riskogruppen oder
          befinde mich in Quarant√§ne, weshalb mir der Weg zum Weltladen unm√∂glich oder ein zu hohes
          Risiko ist. Bitte teilen Sie mir mit, ob meine Bestellung an die oben angegebene Anschrift
          geliefert werden kann. F√ºr die Lieferung entstehen keine Kosten.
        </label>
        -->
      </fieldset>
      <label>* = Pflichtfeld</label>
      <fieldset>
        <button type="submit" v-bind:class="{ disabled: buttonIsDisabled() }" v-bind:disabled="buttonIsDisabled()">Bestellung abschicken</button>
      </fieldset>
    </form>
  </div>
  <!-- <script src="https://vuejs.org/js/vue.js"></script> (Development version) -->
  <!-- <script src="lib/vue.js"></script> -->
  <!-- <script src="https://vuejs.org/js/vue.min.js"></script> (Production version) -->
  <script src="lib/vue.min.js"></script>
  <!-- <script src="https://unpkg.com/vue-select@latest"></script>
  <link rel="stylesheet" href="https://unpkg.com/vue-select@latest/dist/vue-select.css"> -->
  <!-- <script src="lib/vue-select@latest"></script> -->
  <!-- <link rel="stylesheet" href="lib/vue-select.css"> -->
  <!-- <script src="https://unpkg.com/ionicons@5.0.0/dist/ionicons.js"></script> -->
  <!-- <script src="ionicons.js"></script> -->
  <!-- <script src="https://unpkg.com/axios/dist/axios.min.js"></script> -->
  <script src="lib/axios.min.js"></script>
  <script>
    window.onload = function() {
      // Collapsible: https://alligator.io/css/collapsible/
      let myLabels = document.querySelectorAll('.lbl-toggle');
      Array.from(myLabels).forEach(label => {
        label.addEventListener('keydown', e => {
          // 32 === spacebar
          // 13 === enter
          if (e.which === 32 || e.which === 13) {
            e.preventDefault();
            label.click();
          };
        });
      });
    }

    // Vue.component('v-select', VueSelect.VueSelect);

    Vue.config.ignoredElements = [/^ion-/];
    
    // Define a new component
    Vue.component('produktgruppe', {
      props: ['typ', 'item', 'items', 'pgl'],
      methods: {
        productsInGroupPromise: function(productgroup, typ) {
          /* https://www.thetechieshouse.com/vue-js-rest-api-example-with-axios-ajax-alternative/ */
          /* https://stackoverflow.com/questions/49661209/get-response-from-axios-with-await-async */
          return axios.get('api/artikel/read_group.php', {
              params: {
                name: productgroup,
                typ: typ
              }
            })
            .then(response => response.data.records)
            .catch(error => console.log(error));
        },
        updateItemProducts: function(typ, position) {
          let item = this.items[typ][position - 1];
          this.productsInGroupPromise(item.productgroup, typ)
            .then(prods => {
              prods.forEach(prod => {
                this.setProdURL(typ, prod)
                this.setImageStyle(typ, prod)
              });
              item.products = prods;
              item.id = "";
              item.lieferant_name = "";
              item.artikel_nr = "";
              item.artikel_name = "";
              item.vk_preis = 0;
              item.pfand = 0;
              item.stueck = 1;
              item.showProdDropdown = false;
            });
        },
        setImageStyle: function(typ, prod) {
          let art_nr = prod.artikel_nr.trim().toLowerCase();
          let art_nr_alphanum = art_nr.replace(/[^\w]/g, ""); // only keep a-z and 0-9
          let fallbackURL = 'KeinBild.png';
          let loadingURL = 'BildLaden.png';
          let url = '';
          let imgStyle = function(url) {
            return "background-image: url('" + url + "');";
          };
          switch (prod.lieferant_name) {
            case 'El Puente':
              let a = art_nr[0]; // 1st character
              let b = art_nr[1]; // 2nd character
              // Sometimes cache is empty and image is generated only after product page was accessed:
              url = 'https://shop.el-puente.de/media/catalog/product/cache/image/700x700/e9c3970ab036de70892d86c6d221abfe/' + a + '/' + b + '/' + art_nr_alphanum + '.jpg';
              prod.imgStyle = imgStyle(url);
              // Also here, sometimes cache is empty, and the above is at least generated when product page is visited (by clicking on image):
              // 'background-image: url('https://shop.el-puente.de/media/catalog/product/cache/thumbnail/130x160/beff4985b56e3afdbeabfc89641a4582/' + a + '/' + b + '/' + art_nr_alphanum + '.jpg');'
              // Check if image does not exist yet (cache is empty):
              let img = new Image();
              img.onerror = () => {
                prod.imgStyle = imgStyle(loadingURL);
                // Access the El Puente product page so that the image is created in the cache
                let produrl = prod.prodURL;
                axios.post('access-ep.php', {
                  url: produrl
                })
                .then(response => {
                  // Try it again:
                  let img2 = new Image();
                  img2.onerror = () => {
                    console.log('EP image ' + url + ' could not be loaded, even after accessing product page ' + produrl + '.');
                    prod.imgStyle = imgStyle(fallbackURL);
                  };
                  img2.onload = () => {
                    console.log('EP image ' + url + ' is available after accessing product page ' + produrl + ' !!!');
                    prod.imgStyle = imgStyle(url); // trigger a reload of image
                  };
                  img2.src = url;
                })
                .catch(error => { // Product page also not available (e.g. product does not exist any more)
                  console.log('EP image ' + url + ' could not be loaded because product page ' + produrl + ' is not available.');
                  prod.imgStyle = imgStyle(fallbackURL);
                });
              };
              img.src = url;
              break;
            case 'WeltPartner':
              url = 'https://shop.weltpartner.de/images/stories/virtuemart/product/resized/' + art_nr + '_380x380.jpg';
              prod.imgStyle = imgStyle(url);
              break;
            case 'GEPA':
              if (typ == 'LM') {
                url = 'https://www.gepa-wug.de/wug/bilder/inhalt/food/normal/' + art_nr_alphanum + '.jpg';
                prod.imgStyle = imgStyle(url);
                break;
              } else if (typ == 'KHW') {
                url = 'https://www.gepa-wug.de/wug/bilder/inhalt/klein/' + art_nr_alphanum + '.jpg';
                prod.imgStyle = imgStyle(url);
                break;
              }
            case 'Globo':
              if (typ == 'KHW') {
                url = 'https://www.gepa-wug.de/wug/bilder/inhalt/klein/' + art_nr_alphanum.toUpperCase() + '.jpg';
                prod.imgStyle = imgStyle(url);
                break;
              }
            default:
              url = fallbackURL;
              prod.imgStyle = imgStyle(url);
          }
          if (prod.lieferant_name != 'El Puente') { // exclude the case where checks have already been made
            // Check if image is available and if not: replace with fallback image
            let img3 = new Image();
            img3.onerror = function() {
              console.log('Image '+this.src+' not there.');
              url = fallbackURL;
              prod.imgStyle = imgStyle(url);
            };
            img3.src = url;
          }
        },
        prodURL: function(typ, prod) {
          let url = '';
          let art_nr = prod.artikel_nr.trim().toLowerCase();
          switch (prod.lieferant_name) {
            case 'El Puente':
              art_nr = art_nr.replace(/ /g, '-');
              url = 'https://shop.el-puente.de/' + art_nr;
              break;
            case 'WeltPartner':
              art_nr = art_nr.replace(/ /g, '-');
              art_nr = art_nr.substring(0, 10).toUpperCase();
              url = 'https://shop.weltpartner.de/suche?keyword=' + art_nr;
              break;
            case 'GEPA':
              let art_nr_alphanum = art_nr.replace(/[^\w]/g, ''); // only keep a-z and 0-9
              if (typ == 'LM') {
                url = 'https://www.gepa-wug.de/wug/media/produktpass/' + art_nr_alphanum + '.pdf';
                break;
              } else if (typ == 'KHW') {
                url = 'https://www.gepa-wug.de/wug/htdocs/index.php?suchart=' + art_nr_alphanum + '&Submit=SUCHEN&serie=&partner=&sID=0101&search=11&produkt=promenu&themah=01&lan=de&land=&priceSearch=-';
                break;
              }
            case 'Globo':
              url = 'https://www.globo-fairtrade.com/search?sSearch=' + art_nr.toUpperCase();
              break;
            default:
              url = '';
          }
          return url;
        },
        setProdURL: function(typ, prod) {
          prod.prodURL = this.prodURL(typ, prod);
        },
        emojiPG: function(pg, typ) {
          switch (pg) {
            case 'Weihnachten':
              if (typ == 'LM') pg = pg + ' üç™üç´';
              else if (typ == 'KHW') pg = pg + ' üéÑüéÅ';
              break;
          }
          return pg;
        }
      },
      template: `
        <div class="produktgruppe">
          <label v-bind:for="'productgroup'+item.position">Produktgruppe</label>
          <select v-bind:id="'productgroup-'+typ.toLowerCase()+'-'+item.position" v-bind:name="'productgroup-'+typ.toLowerCase()+'-'+item.position" v-model="item.productgroup" v-on:change="updateItemProducts(typ, item.position)" required>
            <option value="" disabled selected>Bitte ausw√§hlen...</option>
            <option v-for="pg in pgl" v-bind:value="pg">{{ emojiPG(pg, typ) }}</option>
          </select>
        </div>
      `
    });

    Vue.component('produkt', {
      props: ['typ', 'item', 'curr-formatter'],
      methods: {
        updateItem: function(item) {
          const prod = item.products.filter(p => {
            let id = item.id.split("______");
            return p.lieferant_name === id[0] && p.artikel_nr === id[1]
          })[0];
          item.lieferant_name = prod.lieferant_name;
          item.artikel_nr = prod.artikel_nr;
          item.artikel_name = prod.artikel_name;
          item.vk_preis = prod.vk_preis;
          item.pfand = prod.pfand;
          item.imgStyle = prod.imgStyle;
          item.prodURL = prod.prodURL;
        }
      },
      template: `
        <div class="produkt">
          <label v-bind:for="'product'+item.position">Produkt</label>
          <div class="custom-select">
            <select v-bind:id="'product-'+typ.toLowerCase()+'-'+item.position" v-bind:name="'product-'+typ.toLowerCase()+'-'+item.position" v-model="item.id" v-on:change="updateItem(item)" required>
              <option value="" disabled selected>Bitte ausw√§hlen...</option>
              <option v-for="p in item.products" v-bind:value="p.lieferant_name+'______'+p.artikel_nr">{{ p.artikel_name + ' (' + p.lieferant_name + ')' }}</option>
            </select>
            <div class="select-selected" @click="item.showProdDropdown = !item.showProdDropdown" :class="{ 'select-arrow-active': item.showProdDropdown, 'nothing-selected': item.id == '' }">
              <div v-if="item.prodURL != ''" class="produktimg" title="Klicken f√ºr mehr Infos">
                <a target="_blank" rel="noopener noreferrer" :href="item.prodURL">
                  <div :style="item.imgStyle"></div>
                </a>
              </div>
              <div v-else class="produktimg">
                <div :style="item.imgStyle"></div>
              </div>
              <div class="produktname">
                <div :title="item.artikel_name">{{ item.artikel_name }}</div>
              </div>
              <div class="lieferant">{{ item.lieferant_name }}</div>
              <div class="preis">{{ currFormatter.format(item.vk_preis) }}</div>
              <div class="produktpfeil">
                <div></div>
              </div>
            </div>
            <div class="select-items" v-show="item.showProdDropdown">
              <div v-for="p in item.products" v-on:click="item.id = p.lieferant_name+'______'+p.artikel_nr; updateItem(item)">
                <div v-if="p.prodURL != ''" class="produktimg" title="Klicken f√ºr mehr Infos">
                  <a target="_blank" rel="noopener noreferrer" :href="p.prodURL">
                    <div :style="p.imgStyle"></div>
                  </a>
                </div>
                <div v-else class="produktimg">
                  <div :style="p.imgStyle"></div>
                </div>
                <div class="produktname">
                  <div :title="p.artikel_name">{{ p.artikel_name }}</div>
                </div>
                <div class="lieferant">{{ p.lieferant_name }}</div>
                <div class="preis">{{ currFormatter.format(p.vk_preis) }}</div>
              </div>
            </div>
          </div>
        </div>
      `
    });

    Vue.component('stueck', {
      props: ['typ', 'item'],
      template: `
        <div class="stueck">
          <label v-bind:for="'stueck'+item.position">St√ºck</label>
          <input type="number" v-bind:id="'stueck-'+typ.toLowerCase()+'-'+item.position" v-bind:name="'stueck-'+typ.toLowerCase()+'-'+item.position" min="1" max="1000" v-model="item.stueck">
        </div>
      `
    });

    Vue.component('preis', {
      props: ['typ', 'item', 'curr-formatter'],
      methods: {
        preis: function(item) {
          return this.currFormatter.format(item.vk_preis * item.stueck);
        }
      },
      template: `
        <div class="preis">
          <label v-bind:for="'preis'+item.position">Preis</label>
          <input type="text" v-bind:id="'preis-'+typ.toLowerCase()+'-'+item.position" v-bind:name="'preis-'+typ.toLowerCase()+'-'+item.position" v-bind:value="preis(item)" disabled>
        </div>
      `
    });

    Vue.component('muelltonne', {
      props: ['typ', 'item', 'items'],
      methods: {
        removeProduct: function(typ, position) {
          this.items[typ].splice(position - 1, 1);
          // same behavior as:
          // Vue.delete(this.items[typ], position - 1);
          /* reassign positions as it is necessary when product was not removed from end */
          let i = 1;
          for (let item of this.items[typ]) {
            item.position = i;
            i += 1;
          }
        }
      },
      template: `
        <button type="button" class="muelltonne square" v-on:click="removeProduct(typ, item.position)"><ion-icon name="trash-outline"></ion-icon></button>
      `
    });

    let itemPrototype = {
      position: 1,
      productgroup: "",
      products: [],
      id: "",
      lieferant_name: "",
      artikel_nr: "",
      artikel_name: "",
      vk_preis: 0,
      pfand: 0,
      imgStyle: "",
      prodURL: "",
      stueck: 1,
      showProdDropdown: false
    };

    var app = new Vue({
      el: '#form',
      data: {
        productGroupList: {
          LM: [],
          KHW: []
        },
        items: {
          LM: [], // start with empty list, in order to not enforce that a product of each type must be chosen
          KHW: [] // start with empty list, in order to not enforce that a product of each type must be chosen
        },
        lieferung_required: false,
        currFormatter: Intl.NumberFormat('de-DE', {
          style: 'currency',
          currency: 'EUR'
        })
      },
      methods: {
        addProduct: function(typ) {
          let currPosition = 0;
          if (this.items[typ].length > 0) {
            currPosition = this.items[typ][this.items[typ].length - 1].position;
          }
          let anotherPrototype = Object.assign({}, itemPrototype); // create a new copy, no reference
          anotherPrototype.position = currPosition + 1;
          this.items[typ].push(anotherPrototype);
        },
        zwischensummen: function(typ) {
          let zs = {preis: 0, pfand: 0};
          for (let i of this.items[typ]) {
            zs.preis = zs.preis + i.vk_preis * i.stueck;
            if (i.pfand) {
              zs.pfand = zs.pfand + i.pfand * i.stueck;
            }
          }
          return zs;
        },
        zwischensumme: function(typ) {
          let values = Object.values(this.zwischensummen(typ));
          let sum = values.reduce((a, b) => a + b);
          return this.currFormatter.format(sum);
        },
        gesBetrag: function() {
          let gesPreis = 0;
          let gesPfand = 0;
          for (let typ of Object.keys(this.items)) {
            let zs = this.zwischensummen(typ);
            gesPreis += zs.preis;
            gesPfand += zs.pfand;
          }
          return this.currFormatter.format(gesPreis + gesPfand);
        },
        buttonIsDisabled: function() {
          let l = 0;
          for (let typ of Object.keys(this.items)) {
            l += this.items[typ].length;
          }
          return (l < 1);
        }
      },
      mounted: function() {
        axios.get('api/produktgruppe/read_all.php', {
            params: {
              typ: "LM"
            }
          })
          .then(response => {
            let pgl = response.data.records;
            pgl = pgl.filter(pg => pg !== "Bananen");
            // Put 'Weihnachten' at the top:
            pgl = ['Weihnachten'].concat(pgl.filter(pg => pg !== "Weihnachten"))
            app.productGroupList.LM = pgl;
          })
          .catch(error => console.log(error));
          axios.get('api/produktgruppe/read_all.php', {
            params: {
              typ: "KHW"
            }
          })
          .then(response => {
            let pgl = response.data.records;
            // pgl = pgl.filter(pg => pg !== "Whatever");
            // Put 'Weihnachten' at the top:
            pgl = ['Weihnachten'].concat(pgl.filter(pg => pg !== "Weihnachten"))
            app.productGroupList.KHW = pgl;
          })
          .catch(error => console.log(error));
      }
    });

    /* If the user clicks anywhere outside the select box: close select box(es): */
    document.addEventListener("click", function(e) {
      let cls = "select-selected";
      if (!e.target.classList.contains(cls) &&
        (!e.target.parentNode.classList || !e.target.parentNode.classList.contains(cls)) && // either parent node does not exist (<html>) or it does not have the class
        (!e.target.parentNode.parentNode || !e.target.parentNode.parentNode.classList || !e.target.parentNode.parentNode.classList.contains(cls))) { // either parent node's parent node does not exist (<body>) or it does not have the class
        // close all dropdowns:
        for (let typ of Object.keys(app.items)) {
          for (let item of app.items[typ]) {
            item.showProdDropdown = false;
          }
        }
      }
    });
  </script>
</body>

</html>